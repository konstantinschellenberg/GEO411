---
title: "Preprocess all Data"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    fig_caption: yes
    theme: lumen
    toc: yes
    lof: true
    number_sections: yes
biblio-style: apalike
link-citations: yes
---

```{r libraries, include=FALSE}
library(raster)
library(dplyr)
library(sf)
library(mapview)
library(magrittr)
```



# Goals

- The Goal of this script is to have TWO Dataframes at the end
  + one for all data in 50m resolution
  + one for all data in 100m resolution
- At each step we evaluated the best option to process the data (QGIS, Python, R, SNAP)

# Mask CHM with FNF
- The chm at hand has many non-noData values over man-made structures
- We only want pixels over vegetation
- For that we use the PALSAR-1 FNF Mask

```{r setpath, results="hide"}
fnf_path = "/home/robin/geodata/geo411/GEO411_FSH_Roda/ancillary_data/FNF/TCD_2015_020m_eu_03035_d05_E40N30/TCD_2015_020m_eu_03035_d05_E40N30.tif"
chm_path = "/home/robin/geodata/geo411/GEO411_FSH_Roda/ancillary_data/LAS_diff_Roda_10m_median_NA.tif"
bs_dir = "/home/robin/geodata/geo411/GEO411_FSH_Roda/snap_grd/final_GRDs_SNAP/"
```

## CRSs

-  read both and check for equal CRS
```{r, out.width="30%"}
# read both
fnf = raster(fnf_path)
chm = raster(chm_path)
# check for crs
crs(fnf)
crs(chm)
```

- The CRSs are not equal, so reproject the the fnf (maybe too big??)
- Definitly too big: Reproject the CHM 

```{r reprojectcmh, echo=FALSE}
chm = raster::projectRaster(chm, crs = crs(fnf)) 
```

- Now check if CRSs are equal

```{r checkifequal}
raster::compareCRS(chm, fnf)
```
## CROP FNF to CHM

```{r cropfnftochm, echo=F}
# compute shape for chm
chm_shp = st_bbox(chm) %>% st_as_sfc(., crs=crs(chm)) %>% st_sf(.)
# crop fnf
fnf_crop = crop(fnf, chm_shp)
fnf_masked = mask(fnf_crop, chm_shp)
```

- Resample the chm (10 x 10m) to the fnf (20 x 20m)

```{r resample chm, echo=F}
chm = resample(chm, fnf_masked)
```

- Set all Pixels in CHM to NA that are 0 in fnf

```{r nachm, echo=F}
chm_fnf = chm
chm_fnf[fnf_masked == 0] = NA
# check the numer of pixels with NA before and after masking with fnf
sum(is.na(values(chm)))
sum(is.na(values(chm_fnf)))
```

- Set all values below 0 in chm to NA

```{r chmnodata, echo=F}
chm_fnf[chm_fnf < 0] = NA
sum(is.na(values(chm_fnf)))
```
- reproject the chm to 32632
- and write it
```{r writechm}
chm_fnf_repro = raster::projectRaster(chm_fnf, crs = "+proj=utm +zone=32 +datum=WGS84 +units=m +no_defs")
writeRaster(chm_fnf, "/home/robin/geodata/geo411/GEO411_FSH_Roda/ancillary_data/chm_20m_maskedtofnf_32632.tif")
```

- read the chm and resample it to 50m

```{r readnewchm, echo=F}
chm_new_path  = "/home/robin/geodata/geo411/GEO411_FSH_Roda/ancillary_data/chm_20m_maskedtofnf_32632.tif"
chm_50m_path = "/home/robin/geodata/geo411/GEO411_FSH_Roda/ancillary_data/chm_50m_maskedtofnf_32632.tif"
cmd = sprintf("gdalwarp -tr 50 50 %s %s", chm_new_path, chm_50m_path)
system(cmd)
```


# Backscatter 

- read all backscatters

```{r readbackscatter}
# locaetion on disk
backscatter_paths = list.files("/home/robin/geodata/geo411/GEO411_FSH_Roda/snap_grd/final_GRDs_SNAP/", full.names = T)
backscatter_paths = backscatter_paths %>% stringr::str_subset(., pattern = "Cal_TC.tif", negate = F)
# load into list
backscatter_list = lapply(backscatter_paths, function(x) raster(x))
# make names
names_backscatter = lapply(backscatter_list, function(x) paste0("bs_", substr(names(x), start=40, stop=45)))
# apply names
names(backscatter_list) = names_backscatter
```

